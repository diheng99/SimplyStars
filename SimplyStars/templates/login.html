{% extends "base.html" %}

{% block title %}
Login Page
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
{% endblock %}

{% block content %}
<div class="container text-center">
    <h2 class="welcome-header" style="color: aquamarine;">You are 1 step away from using SimplyStars! Login</h2>
    <br>

    <form id="loginForm" method="POST" class="text-left" style="width: 50%; margin: 0 auto;">
        {{ form.hidden_tag() }}

        <div class="form-group">
            <label for="{{ form.username.id }}">Enter your username:</label>
            {{ form.username(class="form-control", placeholder="Username") }}
        </div>

        <div class="form-group">
            <label for="{{ form.password.id }}">Enter your password:</label>
            {{ form.password(class="form-control", placeholder="Password") }}
        </div>

        <button type="submit" class="btn btn-sm btn-secondary mt-2">Login</button>

        <div class="mt-4">
            <h6>Don't have an account?</h6>
            <a class="btn btn-sm btn-secondary" href="{{ url_for('register_page') }}">Register</a>
        </div>

        <div class="mt-2">
            <h6>Forgot your password?</h6>
            <a class="btn btn-sm btn-secondary" href="{{ url_for('forgetPassword_page') }}">Forgot Password</a>
        </div>
    </form>

    <!-- Password Reset Modal -->
    <div class="modal fade" id="passwordResetModal" tabindex="-1" role="dialog"
        aria-labelledby="passwordResetModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="passwordResetModalLabel">Reset Password Required</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    You have exceeded the maximum login attempts. Please reset your password.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <a href="/forgetPassword" class="btn btn-primary">Reset Password</a>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function () {
        // Listen for the form submission
        $("#loginForm").submit(function (event) {
            // Prevent the default form submission
            event.preventDefault();

            // Start the AJAX call to the Flask login route
            $.ajax({
                type: 'POST',
                url: "{{ url_for('login_page') }}",
                data: $(this).serialize(),
                dataType: 'json', // Expect a JSON response
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                },
                success: function (response) {
                    // If the login is successful, redirect to the main page
                    if (response.success) {
                        window.location.href = "{{ url_for('main_page') }}";
                    } else {
                        // If there is an error, check the error message
                        if (response.error === "Exceed Login Attempts") {
                            // Show the password reset modal
                            $('#passwordResetModal').modal('show');
                        } else {
                            // Handle other errors, perhaps display them in a div above the form
                            $('#loginError').text(response.error).show();
                        }
                    }
                },
                error: function (xhr, status, error) {
                    // Handle any other errors
                    $('#loginError').text("An error occurred while attempting to log in.").show();
                }
            });
        });
    });
</script>


{% endblock %}