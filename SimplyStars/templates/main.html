{% extends "base.html" %}

{% block head %}
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css')}}">
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
{% endblock %}

{% block title %}
Main
{% endblock %}

{% block content %}
<form action="/delete" method="POST">
    <button type="submit">Delete All</button>
</form>
<div class="login-container">
    <h2>Add your course</h2>
    <form id="courseForm" method="POST">
        {{ form.hidden_tag() }}
        <div class="form-group">
            <!-- renders the label and input field -->
            {{ form.course_code.label() }}
            {{ form.course_code() }}
        </div>
        <div class="form-group">
            {{ form.add() }}
        </div>
    </form>
</div>

<form id="timeForm">
    <input type="radio" id="morning" name="time" value="morning">
    <label for="morning">Morning</label><br>
    <input type="radio" id="afternoon" name="time" value="afternoon">
    <label for="afternoon">Afternoon</label>
</form>

<label for="num_days">Select number of days:</label>
<select name="num_days" id="num_days">
    <option value="">Please select</option> <!-- Default unselected option -->
    {% for num in range(2, 6) %}
    <option value="{{ num }}">{{ num }}</option>
    {% endfor %}
</select>


<button id="automateBtn">Automate</button>

<!-- Overlay (hidden by default) -->
<div id="overlay" style="display:none;">
    <div id="text">Generating...</div>
</div>


<div class="content-container">
    <div class="course_container">
        <h2>Your Courses</h2>
        <ul>
            {% for course in user_courses %}
            <li>
                <span>{{ course.course_code }}</span>
                <span>{{ course.course_name }}</span>
                <span>{{ course.course_au }}</span>
                <!-- Delete button form -->
                <form action="{{ url_for('delete_course', course_code=course.course_code) }}" method="POST">
                    <input type="hidden" name="course_code" value="{{ course.course_code }}">
                    <button type="submit">Remove</button>
                </form>
            </li>
            {% endfor %}
        </ul>
    </div>

    <div>

        <div class="timetable-container">
            <table id="timetable">
                <thead>
                    <tr>
                        <th>Time</th>
                        {% for day in ['MON', 'TUE', 'WED', 'THU', 'FRI'] %}
                        <th>{{ day }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for time_slot in schedule %}
                    <tr>
                        <td>{{ time_slot }}</td>
                        {% for day in ['MON', 'TUE', 'WED', 'THU', 'FRI'] %}
                        <td>
                            {% set day_schedule = weekly_schedules.get(day, {}).get(time_slot, []) %}
                            {% for class in day_schedule %}
                            Type: {{ class['type'] }},
                            Course Index: {{ class['index'] }},
                            Group: {{ class['group'] }},
                            Venue: {{ class['venue'] }},
                            Remarks: {{ class.get('remarks', '') }}<br>
                            {% endfor %}
                            {% if day_schedule|length == 0 %}
                            <!-- Empty cell for no class -->
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>

    {% endblock %}

    {% block scripts %}
    <script type="text/javascript">
        // Ready is a function to only run the code after form is submitted
        $(document).ready(function () {
            $('#courseForm').on('submit', function (e) { // Listens for a form id courseForm to be submitted
                e.preventDefault(); // pass the form to ajax

                $.ajax({    // A http method without the need to reload the page
                    url: 'main',
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function (response) {
                        if (response.status === 'error') {
                            showModal(response.message);
                        }
                        if (response.status === 'success') {
                            location.reload();
                            //$('ul').append('<li>' + response.new_course + '</li>');
                            //$('#courseForm input[name="course_code"]').val('');
                        }
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
            });
        });

    </script>

    <script>
        document.getElementById("timeForm").addEventListener("change", function () {
            const selectedTime = document.querySelector('input[name="time"]:checked').value;
            fetch("/set_time_preference", {
                method: "POST",
                body: JSON.stringify({ time: selectedTime }),
                headers: {
                    'Content-Type': 'application/json',
                },
            })
                .then(response => response.json())
                .then(data => console.log(data))
                .catch((error) => {
                    console.error('Error:', error);
                });
        });
    </script>

    <script type="text/javascript">
        $(document).ready(function () {
            $('#num_days').change(function () {
                var selectedDays = $(this).val();
                $.ajax({
                    url: "{{ url_for('set_day_preference') }}", // Flask route that handles the AJAX request
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ num_days: selectedDays }),
                    dataType: 'json',
                    success: function (response) {
                        // Handle response here
                        console.log(response);
                        // Optionally, update the UI based on the response
                    },
                    error: function (error) {
                        console.error("Error:", error);
                    }
                });
            });
        });
    </script>

    <script>
        $(document).ready(function(){
            $("#automateBtn").click(function(){
                // Show the overlay
                $("#overlay").fadeIn(300);
        
                // Start the AJAX call to your Flask route
                $.ajax({
                    url: "{{ url_for('automate_timetable') }}", // Adjust with your route's name
                    type: 'GET', // or 'POST', depending on your route
                    success: function(response) {
                        // Process the response here
                        location.reload();
                        // Hide the overlay once the call is successful
                        $("#overlay").fadeOut(300);
                    },
                    error: function(xhr, status, error) {
                        // Handle errors here, such as showing an error message
                        console.error("Error: " + error);
                        alert("Fail to automate")
                        $("#overlay").fadeOut(300);
                    }
                });
            });
        });
        </script>

{% endblock %}